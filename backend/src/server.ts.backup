// src/server.ts - VERSION COMPLÃˆTE AVEC TOUTES LES ROUTES
import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';

dotenv.config();

const app = express();
const PORT = process.env.PORT || 5000;

app.use(cors());
app.use(express.json());

// ==================== CHARGEMENT DES ROUTES ====================

// Route produits basique (pour tester)
app.get('/api/products', (req: express.Request, res: express.Response) => {
  res.json({
    success: true,
    message: 'Liste des produits',
    data: [
      { id: 1, name: 'Produit 1', price: 29.99 },
      { id: 2, name: 'Produit 2', price: 39.99 }
    ]
  });
});

app.get('/api/products/:id', (req: express.Request, res: express.Response) => {
  res.json({
    success: true,
    message: `DÃ©tail produit ${req.params.id}`,
    data: { id: req.params.id, name: 'Produit Test', price: 29.99 }
  });
});

// Route services basique (pour tester)
app.get('/api/services', (req: express.Request, res: express.Response) => {
  res.json({
    success: true,
    message: 'Liste des services',
    data: [
      { id: 1, name: 'Soin du visage', price: 50, duration: 60 },
      { id: 2, name: 'Massage relaxant', price: 70, duration: 90 }
    ]
  });
});

app.get('/api/services/:id', (req: express.Request, res: express.Response) => {
  res.json({
    success: true,
    message: `DÃ©tail service ${req.params.id}`,
    data: { id: req.params.id, name: 'Soin du visage', price: 50 }
  });
});

app.get('/api/services/:id/beauticians', (req: express.Request, res: express.Response) => {
  res.json({
    success: true,
    message: `EsthÃ©ticiennes pour service ${req.params.id}`,
    data: [
      { id: 1, name: 'Marie Dupont', specialty: 'Soins visage' },
      { id: 2, name: 'Sophie Martin', specialty: 'Massages' }
    ]
  });
});

// ==================== CHARGEMENT DES ROUTES ====================

// Authentification
try {
  const authRoutes = require('./routes/auth');
  app.use('/api/auth', authRoutes);
  console.log('âœ… Route /api/auth chargÃ©e avec succÃ¨s');
} catch (error: any) {
  console.log('âŒ Erreur chargement route /api/auth:', error.message);
}

// ==================== CHARGEMENT DES ROUTES ====================

// ==================== CHARGEMENT DES ROUTES ====================

// Produits
try {
  const productRoutes = require('./routes/products'); // Chemin corrigÃ©
  app.use('/api/products', productRoutes);
  console.log('âœ… Route /api/products chargÃ©e avec succÃ¨s');
} catch (error: any) {
  console.log('âŒ Erreur chargement route /api/products:', error.message);
}

// Services
try {
  const serviceRoutes = require('./routes/services'); // Chemin corrigÃ©
  app.use('/api/services', serviceRoutes);
  console.log('âœ… Route /api/services chargÃ©e avec succÃ¨s');
} catch (error: any) {
  console.log('âŒ Erreur chargement route /api/services:', error.message);
}

// Rendez-vous
try {
  const appointmentRoutes = require('./routes/appointments');
  app.use('/api/appointments', appointmentRoutes);
  console.log('âœ… Route /api/appointments chargÃ©e avec succÃ¨s');
} catch (error: any) {
  console.log('âŒ Erreur chargement route /api/appointments:', error.message);
}

// Panier
try {
  const cartRoutes = require('./routes/cart');
  app.use('/api/cart', cartRoutes);
  console.log('âœ… Route /api/cart chargÃ©e avec succÃ¨s');
} catch (error: any) {
  console.log('âŒ Erreur chargement route /api/cart:', error.message);
}

// Commandes
try {
  const orderRoutes = require('./routes/orders');
  app.use('/api/orders', orderRoutes);
  console.log('âœ… Route /api/orders chargÃ©e avec succÃ¨s');
} catch (error: any) {
  console.log('âŒ Erreur chargement route /api/orders:', error.message);
}

// Avis
try {
  const reviewRoutes = require('./routes/reviews');
  app.use('/api/reviews', reviewRoutes);
  console.log('âœ… Route /api/reviews chargÃ©e avec succÃ¨s');
} catch (error: any) {
  console.log('âŒ Erreur chargement route /api/reviews:', error.message);
}

// Newsletter
try {
  const newsletterRoutes = require('./routes/newsletter');
  app.use('/api/newsletter', newsletterRoutes);
  console.log('âœ… Route /api/newsletter chargÃ©e avec succÃ¨s');
} catch (error: any) {
  console.log('âŒ Erreur chargement route /api/newsletter:', error.message);
}

// Blog
try {
  const blogRoutes = require('./routes/blog');
  app.use('/api/blog', blogRoutes);
  console.log('âœ… Route /api/blog chargÃ©e avec succÃ¨s');
} catch (error: any) {
  console.log('âŒ Erreur chargement route /api/blog:', error.message);
}

// Administration
try {
  const adminRoutes = require('./routes/admin');
  app.use('/api/admin', adminRoutes);
  console.log('âœ… Route /api/admin chargÃ©e avec succÃ¨s');
} catch (error: any) {
  console.log('âŒ Erreur chargement route /api/admin:', error.message);
}

// CatÃ©gories
try {
  const categoryRoutes = require('./routes/categories');
  app.use('/api/categories', categoryRoutes);
  console.log('âœ… Route /api/categories chargÃ©e avec succÃ¨s');
} catch (error: any) {
  console.log('âŒ Erreur chargement route /api/categories:', error.message);
}

// Configuration du site
try {
  const siteConfigRoutes = require('./routes/siteConfigRoutes');
  app.use('/api/config', siteConfigRoutes);
  console.log('âœ… Route /api/config chargÃ©e avec succÃ¨s');
} catch (error: any) {
  console.log('âŒ Erreur chargement route /api/config:', error.message);
}

// ==================== MIDDLEWARES GLOBAUX ====================

// Maintenance mode (Ã  ajouter si nÃ©cessaire)
// import { checkMaintenanceMode } from './middleware/maintenance';
// app.use(checkMaintenanceMode);

// Gestion des erreurs
// import errorHandler from './middleware/errorHandler';
// app.use(errorHandler);

// ==================== DÃ‰MARRAGE DU SERVEUR ====================

app.listen(PORT, () => {
  console.log('='.repeat(60));
  console.log('ðŸš€ SERVEUR NATURA DIVINE BEAUTÃ‰ - DÃ‰MARRÃ‰ AVEC SUCCÃˆS!');
  console.log(`ðŸ“ Port: ${PORT}`);
  console.log(`ðŸŒ URL: http://localhost:${PORT}`);
  console.log(`ðŸ“± Environnement: ${process.env.NODE_ENV || 'development'}`);
  console.log('='.repeat(60));
  console.log('\nðŸ“‹ ENDPOINTS DISPONIBLES:');
  console.log('\nðŸ‘¤ AUTHENTIFICATION:');
  console.log('   POST /api/auth/register         - Inscription');
  console.log('   POST /api/auth/login            - Connexion');
  console.log('   GET  /api/auth/me               - Profil utilisateur');
  console.log('   PUT  /api/auth/profile          - Mise Ã  jour profil');
  console.log('   PUT  /api/auth/change-password  - Changer mot de passe');
  console.log('   POST /api/auth/forgot-password  - Mot de passe oubliÃ©');
  console.log('   POST /api/auth/reset-password/:token - RÃ©initialisation');
  
  console.log('\nðŸ›ï¸  PRODUITS:');
  console.log('   GET  /api/products              - Liste des produits');
  console.log('   GET  /api/products/:id          - DÃ©tail produit');
  console.log('   POST /api/products              - CrÃ©er produit (admin)');
  console.log('   PUT  /api/products/:id          - Modifier produit (admin)');
  console.log('   DELETE /api/products/:id        - Supprimer produit (admin)');
  
  console.log('\nðŸ’† SERVICES:');
  console.log('   GET  /api/services              - Liste des services');
  console.log('   GET  /api/services/:id          - DÃ©tail service');
  console.log('   POST /api/services              - CrÃ©er service (admin)');
  
  console.log('\nðŸ“… RENDEZ-VOUS:');
  console.log('   GET  /api/appointments          - Mes rendez-vous');
  console.log('   POST /api/appointments          - Prendre rendez-vous');
  console.log('   GET  /api/appointments/:id      - DÃ©tail rendez-vous');
  console.log('   PUT  /api/appointments/:id/cancel - Annuler rendez-vous');
  console.log('   GET  /api/appointments/availability - CrÃ©neaux disponibles');
  
  console.log('\nðŸ›’ PANIER:');
  console.log('   GET  /api/cart                  - Voir le panier');
  console.log('   POST /api/cart/items            - Ajouter au panier');
  console.log('   PUT  /api/cart/items/:itemId    - Modifier quantitÃ©');
  console.log('   DELETE /api/cart/items/:itemId  - Retirer du panier');
  console.log('   DELETE /api/cart                - Vider le panier');
  
  console.log('\nðŸ“¦ COMMANDES:');
  console.log('   GET  /api/orders                - Mes commandes');
  console.log('   POST /api/orders                - Passer commande');
  console.log('   GET  /api/orders/:id            - DÃ©tail commande');
  
  console.log('\nâ­ AVIS:');
  console.log('   GET  /api/reviews               - Avis des produits');
  console.log('   POST /api/reviews               - Donner un avis');
  
  console.log('\nðŸ“§ NEWSLETTER:');
  console.log('   POST /api/newsletter/subscribe  - S\'abonner');
  
  console.log('\nðŸ“ BLOG:');
  console.log('   GET  /api/blog                  - Articles du blog');
  console.log('   GET  /api/blog/:id              - DÃ©tail article');
  
  console.log('\nâš™ï¸  CONFIGURATION:');
  console.log('   GET  /api/config                - Configuration du site');
  
  console.log('\nðŸ”§ UTILITAIRES:');
  console.log('   GET  /                          - Page d\'accueil API');
  console.log('   GET  /health                    - SantÃ© du serveur');
  
  console.log('\nðŸ›‘ Pour arrÃªter le serveur: Ctrl + C');
  console.log('='.repeat(60));
});

// Gestion des routes non trouvÃ©es
app.use('*', (req: express.Request, res: express.Response) => {
  res.status(404).json({
    success: false,
    message: 'Route non trouvÃ©e',
    path: req.originalUrl
  });
});

// Gestion des erreurs globales
app.use((error: any, req: express.Request, res: express.Response, next: express.NextFunction) => {
  console.error('Erreur serveur:', error);
  res.status(500).json({
    success: false,
    message: 'Erreur interne du serveur',
    error: process.env.NODE_ENV === 'development' ? error.message : 'Something went wrong'
  });
});